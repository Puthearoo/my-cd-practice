name: CI/CD HTML Deployment

on:
  push:
    branches: [test-workflow]

jobs:
  deploy-html:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug project structure
        run: |
          echo "ğŸ“ Project structure:"
          ls -la
          echo "ğŸ“ Frontend contents:"
          if [ -d "my-cicd-frontend" ]; then
            ls -la my-cicd-frontend/
          else
            echo "âŒ my-cicd-frontend directory not found!"
            echo "Available files:"
            find . -maxdepth 2 -type f -name "*.html" || echo "No HTML files found"
            exit 1
          fi

      - name: Validate HTML file
        run: |
          if [ -f "my-cicd-frontend/index.html" ]; then
            echo "âœ… index.html found!"
            # Check if HTML has basic structure
            if grep -q "<!DOCTYPE html>" "my-cicd-frontend/index.html"; then
              echo "âœ… Valid HTML structure"
            else
              echo "âš ï¸  Missing DOCTYPE, but will deploy anyway"
            fi
          else
            echo "âŒ index.html not found in my-cicd-frontend/"
            echo "Looking for HTML files..."
            find . -name "*.html" -type f
            exit 1
          fi

      - name: Create deployment package
        run: |
          # Create a clean deployment folder
          mkdir -p deploy-package

          # Copy all HTML, CSS, JS, and image files
          cp -r my-cicd-frontend/* deploy-package/ 2>/dev/null || true

          # If my-cicd-frontend doesn't exist, look for HTML files in root
          if [ ! -d "my-cicd-frontend" ]; then
            echo "ğŸ“ Copying HTML files from root directory"
            cp *.html deploy-package/ 2>/dev/null || true
            cp *.css deploy-package/ 2>/dev/null || true
            cp *.js deploy-package/ 2>/dev/null || true
          fi

          # Create tar package
          tar -czf frontend.tar.gz -C deploy-package .
          echo "ğŸ“¦ Created deployment package:"
          ls -la frontend.tar.gz

      - name: Test SSH connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SSM_NOST }} # Using your variable name
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSM_NORT }}
          script: |
            echo "âœ… SSH Connection successful!"
            echo "ğŸ“ Preparing server directory: /var/www/my-app"
            sudo mkdir -p /var/www/my-app
            sudo chown -R $USER:$USER /var/www/my-app
            echo "Server ready for deployment ğŸš€"

      - name: Transfer files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ vars.SSM_NOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSM_NORT }}
          source: "frontend.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Deploy to web server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SSM_NOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSM_NORT }}
          script: |
            set -e  # Exit on error

            WEB_DIR="/var/www/my-app"
            echo "ğŸš€ Deploying to: $WEB_DIR"

            # Create backup if exists
            if [ -d "$WEB_DIR" ] && [ "$(ls -A $WEB_DIR)" ]; then
              echo "ğŸ“¦ Creating backup..."
              BACKUP_DIR="/var/www/backups/$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              cp -r $WEB_DIR/* "$BACKUP_DIR"/
              echo "âœ… Backup created at: $BACKUP_DIR"
            fi

            # Clean deployment directory
            rm -rf $WEB_DIR/*

            # Extract new files
            echo "ğŸ“¤ Extracting new version..."
            tar -xzf /tmp/frontend.tar.gz -C $WEB_DIR/

            # Set proper permissions
            chmod -R 755 $WEB_DIR
            chown -R $USER:$USER $WEB_DIR

            # Cleanup temporary files
            rm -f /tmp/frontend.tar.gz

            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“ Deployed files:"
            ls -la $WEB_DIR/
            echo "ğŸŒ Your website is now live at: http://${{ vars.SSM_NOST }}"
            echo "ğŸ‰ CI/CD Deployment Successful!"

      - name: Verify deployment
        run: |
          echo "ğŸŠ Deployment workflow completed!"
          echo "-----------------------------------"
          echo "ğŸŒ Website URL: http://${{ vars.SSM_NOST }}"
          echo "ğŸ–¥ï¸  Server IP: ${{ vars.SSM_NOST }}"
          echo "ğŸ‘¤ Username: ${{ vars.USERNAME }}"
          echo "ğŸš€ Your HTML site is now deployed!"
