name: Frontend CI/CD with Ngrok

on:
  push:
    branches: [test-workflow]
  pull_request:
    branches: [test-workflow]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show project structure
        run: |
          echo "Project structure:"
          ls -la
          echo "Frontend contents:"
          ls -la my-cicd-frontend/

      - name: Deploy Frontend to Server via SSH (with Ngrok)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SERVER_IP }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSH_PORT }}   # default 22 if not set
          script: |
            echo "ðŸš€ Starting frontend deployment with Ngrok..."

            APP_DIR="/var/www/my-app"
            FRONTEND_DIR="$APP_DIR/frontend"
            FRONTEND_PORT=3000
            NGROK_TOKEN="${{ secrets.NGROK_AUTH_TOKEN }}"

            # Prepare frontend directory
            sudo mkdir -p "$FRONTEND_DIR"

            echo "ðŸ“¦ Deploying frontend..."
            sudo cp -r $GITHUB_WORKSPACE/my-cicd-frontend/* "$FRONTEND_DIR/"

            # Install a simple web server (if not already)
            if ! command -v npx &> /dev/null; then
              echo "â¬‡ï¸ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt install -y nodejs
            fi

            # Kill old frontend server if running
            sudo pkill -f "npx serve" || true

            # Start frontend server
            echo "ðŸ”§ Starting frontend on port $FRONTEND_PORT..."
            cd "$FRONTEND_DIR"
            nohup npx serve -s . -l $FRONTEND_PORT > frontend.log 2>&1 &

            # Install Ngrok if missing
            if ! command -v ngrok &> /dev/null; then
              echo "â¬‡ï¸ Installing Ngrok..."
              curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
                sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
              echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
                sudo tee /etc/apt/sources.list.d/ngrok.list
              sudo apt update && sudo apt install -y ngrok
            fi

            # Configure Ngrok
            ngrok config add-authtoken "$NGROK_TOKEN"

            # Kill old Ngrok if running
            sudo pkill -f "ngrok" || true

            # Start Ngrok tunnel for frontend
            echo "ðŸŒ Starting Ngrok..."
            nohup ngrok http $FRONTEND_PORT --log=stdout > ngrok.log 2>&1 &

            sleep 5

            # Get Ngrok Public URL
            NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -n 1)
            echo "âœ… Frontend exposed at: $NGROK_URL"
