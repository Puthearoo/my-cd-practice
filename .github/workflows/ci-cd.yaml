name: CI/CD HTML Deployment

on:
  push:
    branches: [test-workflow]

jobs:
  deploy-html:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify HTML file exists
        run: |
          echo "ğŸ“ Current directory structure:"
          ls -la
          echo "ğŸ“„ Looking for HTML files..."

          if [ -f "index.html" ]; then
            echo "âœ… Found index.html in root directory!"
            echo "HTML_DIR=." >> $GITHUB_ENV
          else
            echo "âŒ index.html not found in root directory"
            echo "Available files:"
            find . -name "*.html" -type f
            exit 1
          fi

      - name: Create deployment package
        run: |
          echo "ğŸ“¦ Packaging files from: $HTML_DIR"
          tar -czf frontend.tar.gz index.html *.css *.js 2>/dev/null || \
          (echo "Packaging only HTML file" && tar -czf frontend.tar.gz index.html)
          echo "âœ… Package created:"
          ls -la frontend.tar.gz

      - name: Test SSH connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SSM_NOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSM_NORT }}
          script: |
            echo "âœ… SSH Connection successful to ${{ vars.SSM_NOST }}!"
            echo "ğŸ“ Preparing server directory: /var/www/my-app"
            sudo mkdir -p /var/www/my-app
            sudo chown -R $USER:$USER /var/www/my-app
            echo "Server ready for deployment ğŸš€"

      - name: Transfer files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ vars.SSM_NOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSM_NORT }}
          source: "frontend.tar.gz"
          target: "/tmp/"

      - name: Deploy to web server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SSM_NOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSM_NORT }}
          script: |
            set -e

            WEB_DIR="/var/www/my-app"
            echo "ğŸš€ Deploying to: $WEB_DIR"

            # Create backup if exists
            if [ -d "$WEB_DIR" ] && [ "$(ls -A $WEB_DIR)" ]; then
              echo "ğŸ“¦ Creating backup..."
              BACKUP_DIR="/var/www/backups/$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              cp -r $WEB_DIR/* "$BACKUP_DIR"/
              echo "âœ… Backup created at: $BACKUP_DIR"
            fi

            # Clean deployment directory
            rm -rf $WEB_DIR/*

            # Extract new files
            echo "ğŸ“¤ Extracting new version..."
            tar -xzf /tmp/frontend.tar.gz -C $WEB_DIR/

            # Set proper permissions
            chmod -R 755 $WEB_DIR
            chown -R $USER:$USER $WEB_DIR

            # Cleanup temporary files
            rm -f /tmp/frontend.tar.gz

            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“ Deployed files:"
            ls -la $WEB_DIR/
            echo "ğŸŒ Your website is now live at: http://${{ vars.SSM_NOST }}"

      - name: Verify deployment
        run: |
          echo "ğŸŠ Deployment workflow completed!"
          echo "-----------------------------------"
          echo "ğŸŒ Website URL: http://${{ vars.SSM_NOST }}"
          echo "ğŸ–¥ï¸  Server IP: ${{ vars.SSM_NOST }}"
          echo "ğŸ‘¤ Username: ${{ vars.USERNAME }}"
          echo "ğŸš€ Your HTML site is now deployed!"
          echo "âœ… CI/CD Deployment Successful!"
