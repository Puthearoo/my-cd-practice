name: CI/CD Frontend Only

on:
  push:
    branches: [test-workflow]
  pull_request:
    branches: [test-workflow]

env:
  APP_DIR: "/var/www/my-app"
  FRONTEND_DIR: "${{ env.APP_DIR }}/frontend"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show project structure
        run: |
          echo "Project structure:"
          ls -la
          if [ -d "my-cicd-frontend" ]; then
            echo "Frontend contents:"
            ls -la my-cicd-frontend/
          else
            echo "ERROR: my-cicd-frontend directory not found!"
            echo "Available directories:"
            find . -maxdepth 1 -type d | grep -v "^\." | head -10
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: my-cicd-frontend/package-lock.json

      - name: Install and build frontend
        run: |
          cd my-cicd-frontend
          npm ci
          npm run build

      - name: Deploy Frontend via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SERVER_IP }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSH_PORT }}
          script: |
            set -e  # Exit on any error

            echo "ðŸš€ Starting frontend deployment..."

            # Create project directory
            sudo mkdir -p $FRONTEND_DIR

            # Install Nginx if not installed
            if ! command -v nginx &> /dev/null; then
              echo "ðŸ“¦ Installing Nginx..."
              sudo apt update
              sudo apt install -y nginx
            fi

            # Copy built frontend files
            echo "ðŸ“¦ Copying frontend files..."
            sudo rm -rf $FRONTEND_DIR/*
            sudo cp -r $GITHUB_WORKSPACE/my-cicd-frontend/build/* $FRONTEND_DIR/
            sudo chown -R www-data:www-data $FRONTEND_DIR

            # Configure Nginx
            echo "ðŸŒ Setting up Nginx..."
            sudo bash -c 'cat > /etc/nginx/sites-available/my-app << EOF
            server {
                listen 80;
                server_name _;
                root '"$FRONTEND_DIR"';
                index index.html;
                
                # Frontend routing support
                location / {
                    try_files \$uri \$uri/ /index.html;
                }
                
                # Security headers
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-XSS-Protection "1; mode=block" always;
                add_header X-Content-Type-Options "nosniff" always;
            }
            EOF'

            # Enable site
            sudo ln -sf /etc/nginx/sites-available/my-app /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default  # Remove default config

            # Test and restart Nginx
            echo "ðŸ”§ Testing Nginx configuration..."
            sudo nginx -t
            echo "ðŸ”„ Restarting Nginx..."
            sudo systemctl restart nginx

            echo "âœ… Frontend deployment completed!"
            echo "ðŸŒ Visit: http://${{ vars.SERVER_IP }}"
            echo "ðŸ“ Files deployed to: $FRONTEND_DIR"
