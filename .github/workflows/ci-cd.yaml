name: CI/CD with Ngrok

on:
  push:
    branches: [test-workflow]
  pull_request:
    branches: [test-workflow]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show project structure
        run: |
          echo "Project structure:"
          ls -la
          echo "Backend contents:"
          ls -la my-cicd-backend/
          echo "Frontend contents:"
          ls -la my-cicd-frontend/

      - name: Deploy to Server via SSH (with Ngrok)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ vars.SERVER_IP }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ vars.SSH_PORT }}   # ✅ Added SSH port (default 22 if not set)
          script: |
            echo "🚀 Starting deployment with Ngrok..."

            APP_DIR="/var/www/my-app"
            FRONTEND_DIR="$APP_DIR/frontend"
            BACKEND_DIR="$APP_DIR/backend"
            BACKEND_PORT=5000
            NGROK_TOKEN="${{ secrets.NGROK_AUTH_TOKEN }}"

            # Prepare directories
            sudo mkdir -p "$FRONTEND_DIR" "$BACKEND_DIR"

            echo "📦 Deploying frontend..."
            sudo cp -r $GITHUB_WORKSPACE/my-cicd-frontend/* "$FRONTEND_DIR/"

            echo "📦 Deploying backend..."
            sudo cp -r $GITHUB_WORKSPACE/my-cicd-backend/* "$BACKEND_DIR/"

            # Install dependencies
            echo "🐍 Installing Python dependencies..."
            cd "$BACKEND_DIR"
            sudo pip3 install -r requirements.txt

            # Kill old backend if running
            sudo pkill -f "python3 app.py" || true

            # Start backend
            echo "🔧 Starting backend..."
            nohup sudo python3 app.py > backend.log 2>&1 &

            # Install Ngrok if missing
            if ! command -v ngrok &> /dev/null; then
              echo "⬇️ Installing Ngrok..."
              curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
                sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
              echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
                sudo tee /etc/apt/sources.list.d/ngrok.list
              sudo apt update && sudo apt install -y ngrok
            fi

            # Configure Ngrok
            ngrok config add-authtoken "$NGROK_TOKEN"

            # Kill old Ngrok if running
            sudo pkill -f "ngrok" || true

            # Start Ngrok tunnel
            echo "🌐 Starting Ngrok..."
            nohup ngrok http $BACKEND_PORT --log=stdout > ngrok.log 2>&1 &

            sleep 5

            # Get Ngrok Public URL
            NGROK_URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -n 1)
            echo "✅ Backend exposed at: $NGROK_URL"
